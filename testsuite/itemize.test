#! /bin/sh

# Copyright (C) 2005 by Wayne Davison <wayned@samba.org>

# This program is distributable under the terms of the GNU GPL (see
# COPYING).

# Test the output of various copy commands to ensure itemized output
# and double-verbose output is correct.

. "$suitedir/rsync.fns"

case "$RSYNC" in
*protocol=29*)
    sed_cmd='/_P30_/d; s/_P29_//'
    ;;
*)
    sed_cmd='/_P29_/d; s/_P30_//'
    ;;
esac

to2dir="$tmpdir/to2"

chkfile="$scratchdir/rsync.chk"
outfile="$scratchdir/rsync.out"

makepath "$fromdir/foo"
makepath "$fromdir/bar/baz"
cp -p "$srcdir/configure.in" "$fromdir/foo/config1"
cp -p "$srcdir/config.h.in" "$fromdir/foo/config2"
cp -p "$srcdir/rsync.h" "$fromdir/bar/baz/rsync"
chmod 600 "$fromdir"/foo/config? "$fromdir/bar/baz/rsync"
umask 0
ln -s ../bar/baz/rsync "$fromdir/foo/sym"
umask 022
ln "$fromdir/foo/config1" "$fromdir/foo/extra"

# Check if the OS can hard-link symlinks or not
ln -s no-such-dir "$to2dir"
if ln "$to2dir" "$to2dir.test" 2>/dev/null; then
    L=hL
else
    L=cL
fi
rm -f "$to2dir" "$to2dir.test"

$RSYNC -iplr "$fromdir/" "$todir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
cd+++++++ ./
cd+++++++ bar/
cd+++++++ foo/_P30_
cd+++++++ bar/baz/
>f+++++++ bar/baz/rsync
cd+++++++ foo/_P29_
>f+++++++ foo/config1
>f+++++++ foo/config2
>f+++++++ foo/extra
cL+++++++ foo/sym -> ../bar/baz/rsync
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 1 failed"

# Ensure there are no accidental directory-time problems.
$RSYNC -a -f '-! */' "$fromdir/" "$todir"

cp -p "$srcdir/configure.in" "$fromdir/foo/config2"
chmod 601 "$fromdir/foo/config2"
$RSYNC -iplrH "$fromdir/" "$todir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
>f..T.... bar/baz/rsync
>f..T.... foo/config1
>f.sTp... foo/config2
hf..T.... foo/extra => foo/config1
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 2 failed"

$RSYNC -a -f '-! */' "$fromdir/" "$todir"
sleep 1 # For directory mod below to ensure time difference
rm "$todir/foo/sym"
umask 0
ln -s ../bar/baz "$todir/foo/sym"
umask 022
cp -p "$srcdir/config.h.in" "$fromdir/foo/config2"
chmod 600 "$fromdir/foo/config2"
chmod 777 "$todir/bar/baz/rsync"

$RSYNC -iplrtc "$fromdir/" "$todir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
.d..t.... foo/_P30_
.f..tp... bar/baz/rsync
.d..t.... foo/_P29_
.f..t.... foo/config1
>fcstp... foo/config2
cL..T.... foo/sym -> ../bar/baz/rsync
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 3 failed"

cp -p "$srcdir/configure.in" "$fromdir/foo/config2"
chmod 600 "$fromdir/foo/config2"
# Lack of -t is for unchanged hard-link stress-test!
$RSYNC -vvplrH "$fromdir/" "$todir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
bar/baz/rsync is uptodate
foo/config1 is uptodate
foo/config2
foo/extra is uptodate
foo/sym is uptodate
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 4 failed"

chmod 747 "$todir/bar/baz/rsync"
$RSYNC -a -f '-! */' "$fromdir/" "$todir"
$RSYNC -ivvplrtH "$fromdir/" "$todir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
.d        ./
.d        bar/
.d        bar/baz/
.f...p... bar/baz/rsync
.d        foo/
.f        foo/config1
>f..t.... foo/config2
hf        foo/extra
.L        foo/sym -> ../bar/baz/rsync
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 5 failed"

chmod 757 "$todir/foo/config1"
touch "$todir/foo/config2"
$RSYNC -vplrtH "$fromdir/" "$todir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
foo/config2
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 6 failed"

chmod 757 "$todir/foo/config1"
touch "$todir/foo/config2"
$RSYNC -iplrtH "$fromdir/" "$todir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
.f...p... foo/config1
>f..t.... foo/config2
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 7 failed"

$RSYNC -ivvplrtH --copy-dest=../to "$fromdir/" "$to2dir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
cd        ./
cd        bar/
cd        bar/baz/
cf        bar/baz/rsync
cd        foo/
cf        foo/config1
cf        foo/config2
hf        foo/extra => foo/config1
cL        foo/sym -> ../bar/baz/rsync
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 8 failed"

rm -rf "$to2dir"
$RSYNC -iplrtH --copy-dest=../to "$fromdir/" "$to2dir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
hf        foo/extra => foo/config1
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 9 failed"

rm -rf "$to2dir"
$RSYNC -vvplrtH --copy-dest="$todir" "$fromdir/" "$to2dir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
./ is uptodate
bar/ is uptodate
bar/baz/ is uptodate
bar/baz/rsync is uptodate
foo/ is uptodate
foo/config1 is uptodate
foo/config2 is uptodate
foo/extra => foo/config1
foo/sym is uptodate
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 10 failed"

rm -rf "$to2dir"
$RSYNC -ivvplrtH --link-dest="$todir" "$fromdir/" "$to2dir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
cd        ./
cd        bar/
cd        bar/baz/
hf        bar/baz/rsync
cd        foo/
hf        foo/config1
hf        foo/config2
hf        foo/extra => foo/config1
$L        foo/sym -> ../bar/baz/rsync
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 11 failed"

rm -rf "$to2dir"
$RSYNC -iplrtH --dry-run --link-dest=../to "$fromdir/" "$to2dir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 12 failed"

rm -rf "$to2dir"
$RSYNC -iplrtH --link-dest=../to "$fromdir/" "$to2dir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 13 failed"

rm -rf "$to2dir"
$RSYNC -vvplrtH --link-dest="$todir" "$fromdir/" "$to2dir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
./ is uptodate
bar/ is uptodate
bar/baz/ is uptodate
bar/baz/rsync is uptodate
foo/ is uptodate
foo/config1 is uptodate
foo/config2 is uptodate
foo/extra is uptodate
foo/sym is uptodate
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 14 failed"

rm -rf "$to2dir"
$RSYNC -ivvplrtH --compare-dest="$todir" "$fromdir/" "$to2dir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
cd        ./
cd        bar/
cd        bar/baz/
.f        bar/baz/rsync
cd        foo/
.f        foo/config1
.f        foo/config2
.f        foo/extra
.L        foo/sym -> ../bar/baz/rsync
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 15 failed"

rm -rf "$to2dir"
$RSYNC -iplrtH --compare-dest="$todir" "$fromdir/" "$to2dir/" \
    | tee "$outfile"
sed -e "$sed_cmd" <<EOT >"$chkfile"
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 16 failed"

rm -rf "$to2dir"
$RSYNC -vvplrtH --compare-dest="$todir" "$fromdir/" "$to2dir/" \
    | tee "$outfile"
filter_outfile
sed -e "$sed_cmd" <<EOT >"$chkfile"
./ is uptodate
bar/ is uptodate
bar/baz/ is uptodate
bar/baz/rsync is uptodate
foo/ is uptodate
foo/config1 is uptodate
foo/config2 is uptodate
foo/extra is uptodate
foo/sym is uptodate
EOT
diff $diffopt "$chkfile" "$outfile" || test_fail "test 17 failed"

# The script would have aborted on error, so getting here means we've won.
exit 0
